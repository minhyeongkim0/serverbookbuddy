<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}">
    <title>κ±°λ μƒμ„Έ - BookBuddy</title>
</head>
<body>

<div th:replace="~{fragments/bodyHeader :: bodyHeader}"></div>

<div class="container">
    <h3 class="mb-4">π“„ κ±°λ μƒμ„Έ</h3>
    <!-- β­ μ—λ¬ μ•λ‚΄ λ°•μ¤ (ν¬μΈνΈ λ¶€μ΅± λ“±) -->
    <div th:if="${errorMessage}"
         class="alert alert-danger"
         role="alert">
        <span th:text="${errorMessage}">ν¬μΈνΈκ°€ λ¶€μ΅±ν•©λ‹λ‹¤.</span>
    </div>

    <div class="row">
        <!-- κ±°λ μ •λ³΄ μΉ΄λ“ -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div
                        class="card-header d-flex justify-content-between align-items-center"
                >
                    <h5 class="mb-0">κ±°λ μ •λ³΄</h5>
                    <div>
                <span
                        class="badge bg-warning"
                        th:if="${transaction.status.name() == 'REQUESTED'}"
                >μ‹ μ²­ λ€κΈ°</span
                >
                        <span
                                class="badge bg-info"
                                th:if="${transaction.status.name() == 'ACCEPTED'}"
                        >κ±°λ μ§„ν–‰μ¤‘</span
                        >
                        <span
                                class="badge bg-danger"
                                th:if="${transaction.status.name() == 'REJECTED'}"
                        >κ±°μ λ¨</span
                        >
                        <span
                                class="badge bg-primary"
                                th:if="${transaction.status.name() == 'PAID'}"
                        >κ²°μ μ™„λ£</span
                        >
                        <span
                                class="badge bg-success"
                                th:if="${transaction.status.name() == 'COMPLETED'}"
                        >κ±°λμ™„λ£</span
                        >
                        <span
                                class="badge bg-secondary"
                                th:if="${transaction.status.name() == 'CANCELLED'}"
                        >μ·¨μ†λ¨</span
                        >
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 120px">λ„μ„λ…</th>
                            <td>
                                <a
                                        th:href="@{/books/{id}(id=${transaction.book.id})}"
                                        th:text="${transaction.book.title}"
                                        class="text-decoration-none fw-bold"
                                >λ„μ„λ…</a
                                >
                            </td>
                        </tr>
                        <tr>
                            <th>κ±°λ κΈμ•΅</th>
                            <td>
                                <strong
                                        class="text-primary"
                                        th:text="${#numbers.formatInteger(transaction.price, 0, 'COMMA')} + 'μ›'"
                                >κ°€κ²©</strong
                                >
                            </td>
                        </tr>
                        <tr>
                            <th>νλ§¤μ</th>
                            <td
                                    th:text="${transaction.seller.loginId} + ' (' + ${transaction.seller.department} + ')'">
                                νλ§¤μ
                            </td>
                        </tr>
                        <tr>
                            <th>κµ¬λ§¤μ</th>
                            <td
                                    th:text="${transaction.buyer.loginId} + ' (' + ${transaction.buyer.department} + ')'">
                                κµ¬λ§¤μ
                            </td>
                        </tr>
                        <tr>
                            <th>μ‹ μ²­μΌ</th>
                            <td
                                    th:text="${#temporals.format(transaction.requestedAt, 'yyyy-MM-dd HH:mm')}">
                                μ‹ μ²­μΌ
                            </td>
                        </tr>
                        <tr th:if="${transaction.depositorName != null}">
                            <th>μ…κΈμλ…</th>
                            <td th:text="${transaction.depositorName}">μ…κΈμλ…</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- μ•΅μ… λ²„νΌ μΉ΄λ“ -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body d-grid gap-2">
                    <!-- [Chat] μ±„ν…ν•κΈ° λ²„νΌ -->
                    <button
                            type="button"
                            class="btn btn-primary w-100 mb-2"
                            th:onclick="ChatManager.startChat(
                                [[${isSeller ? transaction.buyer.id : transaction.seller.id}]],
                                [[${transaction.book.id}]],
                                [[${isSeller ? transaction.buyer.loginId : transaction.seller.loginId}]]
                            )">
                        <i class="fas fa-comments me-2"></i>
                        <span
                                th:text="${isSeller ? 'κµ¬λ§¤μμ™€ μ±„ν…ν•κΈ°' : 'νλ§¤μμ™€ μ±„ν…ν•κΈ°'}">
                  μ±„ν…ν•κΈ°
                </span>
                    </button>

                    <hr class="my-2" />

                    <!-- νλ§¤μ: μ‹ μ²­ λ€κΈ° μƒνƒμΌ λ• -->
                    <div
                            th:if="${isSeller and transaction.status.name() == 'REQUESTED'}">
                        <form
                                th:action="@{/transactions/{id}/accept(id=${transaction.id})}"
                                method="post"
                                class="mb-2">
                            <button type="submit" class="btn btn-success w-100">
                                κ±°λ μλ½
                            </button>
                        </form>
                        <form
                                th:action="@{/transactions/{id}/reject(id=${transaction.id})}"
                                method="post">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                κ±°μ 
                            </button>
                        </form>
                    </div>

                    <!-- κµ¬λ§¤μ: κ±°λ μ§„ν–‰μ¤‘μΌ λ• ν¬μΈνΈ κ²°μ  -->
                    <div
                            th:if="${isBuyer and transaction.status.name() == 'ACCEPTED'}">
                        <form
                                th:action="@{/transactions/{id}/pay(id=${transaction.id})}"
                                method="post">
                            <!-- λ°±μ—”λ“μ—μ„ depositorName νλΌλ―Έν„°λ¥Ό μ”κµ¬ν•λ―€λ΅
                                 κµ¬λ§¤μ μ•„μ΄λ””λ¥Ό μ¨κ²¨μ„ λ³΄λ‚΄κΈ° -->
                            <input type="hidden"
                                   name="depositorName"
                                   th:value="${transaction.buyer.loginId}" />

                            <p class="small text-muted mb-2">
                                μ΄ κ±°λ κΈμ•΅μ€ λ³΄μ  ν¬μΈνΈμ—μ„ μ°¨κ°λ©λ‹λ‹¤.
                            </p>
                            <button type="submit" class="btn btn-success w-100">
                                ν¬μΈνΈλ΅ κ²°μ ν•κΈ°
                            </button>
                        </form>
                    </div>

                    <!-- νλ§¤μ: κ²°μ  μƒνƒμ— λ”°λ¥Έ μ•λ‚΄/μ™„λ£ λ²„νΌ -->
                    <div th:if="${isSeller}">
                        <!-- μ•„μ§ κ²°μ  μ „μ΄λ©΄ μ•λ‚΄λ§ -->
                        <div th:if="${transaction.status.name() == 'ACCEPTED'}"
                             class="alert alert-info small py-2 mb-2">
                            μ•„μ§ κµ¬λ§¤μκ°€ ν¬μΈνΈ κ²°μ λ¥Ό ν•μ§€ μ•μ•μµλ‹λ‹¤.
                        </div>

                        <!-- κ²°μ  μ™„λ£(PAID) μ΄ν›„μ—λ§ κ±°λ μ™„λ£ λ²„νΌ λ…Έμ¶ -->
                        <div th:if="${transaction.status.name() == 'PAID'}">
                            <div class="alert alert-warning small py-2 mb-2">
                                π’° <strong>κµ¬λ§¤μκ°€ ν¬μΈνΈ κ²°μ λ¥Ό μ™„λ£ν–μµλ‹λ‹¤.</strong><br />
                                μ…κΈμλ…:
                                <span th:text="${transaction.depositorName}"></span>
                            </div>
                            <form
                                    th:action="@{/transactions/{id}/complete(id=${transaction.id})}"
                                    method="post"
                                    onsubmit="return confirm('λ¬Όν’ μ „λ‹¬μ„ μ™„λ£ν•μ…¨λ‚μ”? κ±°λλ¥Ό μ™„λ£ν•©λ‹λ‹¤.');">
                                <button type="submit" class="btn btn-success w-100">
                                    κ±°λ μµμΆ… μ™„λ£
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- κ±°λ μ·¨μ† (μ™„λ£/κ±°μ /μ·¨μ† μ „κΉμ§€) -->
                    <div
                            th:if="${transaction.status.name() != 'COMPLETED' and transaction.status.name() != 'REJECTED' and transaction.status.name() != 'CANCELLED'}"
                            class="mt-2">
                        <form
                                th:action="@{/transactions/{id}/cancel(id=${transaction.id})}"
                                method="post"
                                onsubmit="return confirm('μ •λ§ κ±°λλ¥Ό μ·¨μ†ν•μ‹κ² μµλ‹κΉ?');">
                            <button
                                    type="submit"
                                    class="btn btn-light text-danger w-100 border-0 btn-sm">
                                κ±°λ μ·¨μ†
                            </button>
                        </form>
                    </div>

                    <!-- μƒνƒ λ©”μ‹μ§€ ν‘μ‹ -->
                    <div
                            th:if="${transaction.status.name() == 'COMPLETED'}"
                            class="alert alert-success text-center mb-0 small">
                        π‰ κ±°λκ°€ μ„±κ³µμ μΌλ΅ μ™„λ£λμ—μµλ‹λ‹¤.
                    </div>
                    <div
                            th:if="${transaction.status.name() == 'CANCELLED'}"
                            class="alert alert-secondary text-center mb-0 small">
                        μ·¨μ†λ κ±°λμ…λ‹λ‹¤.
                    </div>
                    <div
                            th:if="${transaction.status.name() == 'REJECTED'}"
                            class="alert alert-danger text-center mb-0 small">
                        κ±°μ λ κ±°λμ…λ‹λ‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a th:href="@{/transactions}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-1"></i> λ©λ΅μΌλ΅
        </a>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
